# Copilot Instructions — Sound Orchestra MCP

This project is a small MCP (tool) service that turns progress updates into a Pure Data (Pd) soundtrack. Keep instructions short and specific to this repo's structure, conventions, and runtime expectations.

- **Big picture:** Python FastAPI MCP server (`src/main.py`) exposes four tools defined in `manifest.json` and implemented using a single global `PdOrchestra` instance (`src/pd_orchestra.py`). `PdOrchestra` speaks OSC to a Pure Data patch (expected at `pd/orchestra.pd`) on port `4559`.

- **Why this structure:** the Python side provides a stable, testable API and simple tool contracts (see `manifest.json`) while Pd handles realtime audio generation. Keep audio logic in Pd or the `lode/` design docs; keep protocol and business logic in Python.

- **Key files to reference:**
  - `manifest.json` — definitive tool names and input schemas (must match server routes).
  - `src/main.py` — FastAPI endpoints and global `PdOrchestra` instance. Example endpoints: `/start_progress_music`, `/update_progress`, `/finish_progress`, `/play_one_shot`.
  - `src/pd_orchestra.py` — spawns `pd` subprocess, sends OSC messages, and contains sample auto-generation hooks.
  - `pd/orchestra.pd` (Pure Data patch text) — runtime audio patch (may be generated by code). See `lode/pd-patch.md` for required addresses and behavior.
  - `lode/music-design.md` — authoritative mapping of progress → musical behavior and voice milestones. These rules are intentional and must be preserved exactly unless the user explicitly changes them.

- **Runtime / dev workflow:**
  - Install Python deps (examples): `pip install fastapi uvicorn python-osc`.
  - Ensure Pure Data is installed and `pd` is on PATH (the server calls `pd -nogui -open ...`). Pd must accept OSC on port `4559`.
  - Run the MCP server (from repo root):

```powershell
python src/main.py
# or
python -m uvicorn src.main:app --reload --port 2424
```

- **OSC / integration details:**
  - OSC host/port: `127.0.0.1:4559` (see `src/pd_orchestra.py`).
  - Addresses used: `/start`, `/progress` (float 0–100), `/finish` (0/1), `/play_sample` (string path), `/ding`, `/tada`.
  - Voice/sample files are expected under `samples/` (e.g. `samples/voice_20.wav`). `pd_orchestra.play_one_shot` looks for `voice_20.wav` etc.

- **Patterns & conventions unique to this repo:**
  - Single global `PdOrchestra` instance created at import in `src/main.py`. Agents should respect that lifecycle (do not create parallel Pd instances unless instructed).
  - `lode/` holds design notes that are normative (especially `music-design.md`). Don’t change those files without explicit user permission — their content is treated as requirements.
  - `pd/orchestra.pd` is a Pd patch (text format) not Python. `src/pd_orchestra.py` contains a small `generate_patch()` placeholder — currently partial. If you generate/modify the patch, ensure it implements the exact progression rules in `lode/music-design.md` and the OSC addresses in `lode/pd-patch.md`.

- **Concrete examples (use these when writing or testing code):**
  - Start session: `POST /start_progress_music` with `{ "task_name": "build" }`.
  - Update progress: `POST /update_progress` with `{ "percent": 42.5, "message": "running tests" }`.
  - Finish: `POST /finish_progress` with `{ "success": true }`.
  - One-shot voice: `POST /play_one_shot` with `{ "cue": "voice_50" }` or `{ "cue": "custom", "file": "samples/my.wav" }`.

- **What to avoid / gotchas:**
  - Don’t rework `lode/music-design.md` or `lode/pd-patch.md` content unless the user asks — the project treats those as spec.
  - `src/pd_orchestra.generate_patch()` is incomplete and only a placeholder — do not assume a complete `.pd` file exists unless `pd/orchestra.pd` is present.
  - Pd must be available on PATH; otherwise `subprocess.Popen(['pd', ...])` will fail silently.

If anything here is unclear or you want the agent to make an editable change (for example: add a `requirements.txt`, implement the full Pd patch, or add unit tests), say which goal to pursue and I will update the instructions accordingly.
